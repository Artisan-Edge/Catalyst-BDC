# v0.1.1

## Release Date

2026-02-10

## Overview

Catalyst-BDC gains upsert semantics, HTTP-based replication flow execution, and a fully async CLI executor. Objects are now created or updated automatically based on whether they already exist, replication flows can be triggered programmatically via the Datasphere REST API (instead of the UI), and all CLI operations run non-blocking to support concurrent workloads.

## Breaking Changes

No external consumers yet -- all breaking changes are internal.

- **`createReplicationFlow` renamed to `upsertReplicationFlow`** -- The method now checks whether each object exists before choosing create vs. update. The return type `ReplicationFlowResult` adds `flowAction` (`'created' | 'updated'`) and each dependency output now includes an `action` field.
- **`CliExecutor.exec()` is now async** -- Returns `AsyncResult<CliExecResult>` instead of `Result<CliExecResult>`. All call sites must `await` the result.
- **`ClientContext` type removed** -- The internal type was unused and has been deleted.
- **`ReplicationFlowResult` shape changed** -- Adds optional `runResult` field (present when the flow is run after upsert).

## What's New

### Upsert Semantics

`upsertReplicationFlow` checks each dependency local table and the flow itself against the tenant before deciding whether to create or update. This eliminates "already exists" errors when re-running scripts against a partially provisioned tenant. The object type registry now includes `readCommand` and `updateCommand` for every type.

### Replication Flow Execution via HTTP

`client.runReplicationFlow(flowName)` triggers a replication flow run through the Datasphere REST API (`/dwaas-core/replicationflow/.../run`). This bypasses the CLI entirely and enables scripted data replication without the Datasphere UI. The method handles 409 (flow already running) and 401 (expired session) as typed errors.

By default, `upsertReplicationFlow` runs the flow immediately after upserting. Pass `false` as the third argument to skip the run.

### OAuth Session Management

A new `core/http/session.ts` module manages access tokens and CSRF tokens for HTTP API calls. It reads stored OAuth secrets from the CLI's credential store, refreshes expired tokens automatically, and fetches CSRF tokens for mutation endpoints. The `BdcClient` caches session data and refreshes it transparently.

### Async CLI Executor

The executor switched from `execSync` to `spawn`, making all CLI operations non-blocking. `stdin` is closed immediately so interactive prompts (like the login overwrite confirmation) receive EOF and fail fast instead of hanging the process. This enables concurrent object creation.

### Batch Upload Script

`upload.ts` provisions a tenant with replication flows from a directory of CSN files. It processes flows in configurable batches (default concurrency: 20), upserts each flow with its dependency tables, and prints a summary of successes and failures. Built for the Madiba demo tenant setup.

### `objectExists` Check

A new `objectExists` operation probes whether an object already exists by running the type's read command. Used internally by `upsertReplicationFlow` to decide between create and update.

## Technical Details

### Refactoring

- **Generic `createObject`** -- The duplicated create logic in `createView` and `createLocalTable` was extracted into a shared `createObject(csn, name, typeName, executor)` function. Both operations now delegate to it.
- **`withTempCsn` helper** -- Encapsulates the write-temp-file / callback / cleanup pattern. Replaces manual `try/finally` blocks across operations.
- **UUID temp file names** -- Temp CSN files now use `datasphere-csn-${randomUUID()}.json` instead of a fixed name, preventing collisions during concurrent operations.
- **CLI flags as arrays** -- Flags are now passed as separate array elements to `spawn` instead of concatenated strings, fixing quoting issues with file paths.

### Type Safety

- **`safeJsonParse(text, schema)`** -- New Zod-validated JSON parser in `core/utils/json.ts`. Returns `Result<z.infer<S>>` and is used for all external data boundaries (CLI output, HTTP responses).
- **CSN validation via Zod** -- `validateCsnFile` replaced manual `typeof` checks with a `csnFileSchema` Zod schema.
- **Type safety rules codified** -- CLAUDE.md now documents the project's type safety conventions (no `as` casts on external data, mandatory Zod schemas at JSON boundaries, `z.ZodTypeAny` generic pattern).

### Documentation

- **Expanded README** -- Full API reference, script-writing guide, CSN file documentation, and error handling patterns.
- **New `docs/architecture.md`** -- Module hierarchy, import rules, key patterns, and request lifecycle.
- **CLI quirks updated** -- Added sections on delete operations, folder assignments, and login session behavior.
- **`PLAN.md` removed** -- Objectives tracking moved out of the repo (all v0.1.0 items were completed).

### New Files

| File | Purpose |
|------|---------|
| `src/core/http/session.ts` | OAuth token + CSRF management for HTTP API calls |
| `src/core/operations/createObject.ts` | Generic object creation (shared by view + local table) |
| `src/core/operations/objectExists.ts` | Checks if an object exists via read command |
| `src/core/operations/runReplicationFlow.ts` | Runs a replication flow via REST API |
| `src/core/operations/upsertReplicationFlow.ts` | Create-or-update for flows + dependency tables |
| `src/core/utils/json.ts` | `safeJsonParse` with Zod validation |
| `upload.ts` | Batch upload script for Madiba demo provisioning |
| `run-flow.ts` | Script to trigger a single replication flow run |

## Commits Included

| Hash | Message |
|------|---------|
| `742ed1d` | [UPDATE] Improving the readme |
| `b9d036f` | [UPDATE] Better type safety and validation |
| `5d6048d` | [UPDATE] Able to run replication flows now |
| `663b7b0` | [UPDATE] Working on fixing some of the create or update methods |
| `699e2d7` | [UPDATE] Working on improving efficiency |
| `dec7598` | [UPDATE] Fixing an issue where it would hang on login when we already had valid credentials |
| `13420ef` | [UPDATE] Documentation |
